# Output API Inventory (`packages/loopwork/src/core/output.ts`)

This document provide a comprehensive inventory of all exported functions and classes in `packages/loopwork/src/core/output.ts`. This audit ensures that the planned Ink rewrite maintains 100% API compatibility.

## 1. Constants & Types

### `BOX_CHARS`
*   **Type**: `object` (const)
*   **Description**: Unicode box-drawing character sets.
*   **Contract**:
    ```typescript
    {
      light: {
        topLeft: '┌', topRight: '┐', bottomLeft: '└', bottomRight: '┘',
        horizontal: '─', vertical: '│', cross: '┼', teeDown: '┬',
        teeUp: '┴', teeRight: '├', teeLeft: '┤'
      },
      heavy: {
        topLeft: '╔', topRight: '╗', bottomLeft: '╚', bottomRight: '╝',
        horizontal: '═', vertical: '║'
      }
    }
    ```
*   **Call Sites**:
    *   Used internally by `Table` and `Banner` classes.
    *   `packages/loopwork/test/core/output.test.ts` (Testing).

---

## 2. Functions

### `supportsEmoji()`
*   **Contract**: `(): boolean`
*   **Description**: Detects if the current terminal environment supports emojis.
*   **Implementation Note**: Checks `process.stdout.isTTY`, `process.platform`, and `process.env.TERM`.
*   **Call Sites**:
    *   `packages/loopwork/src/core/output.ts`: Used by `getEmoji()`.
    *   `packages/loopwork/test/core/output.test.ts` (Testing).

### `getEmoji(emoji: string)`
*   **Contract**: `(emoji: string): string`
*   **Description**: Returns the requested emoji if supported, or an ASCII fallback defined in `EMOJI_FALLBACKS`.
*   **Fallbacks**:
    *   `✅` -> `[OK]`
    *   `❌` -> `[ERR]`
    *   `⚠️` -> `[WARN]`
    *   `ℹ️` -> `[INFO]`
    *   `→` -> `->`
    *   `✓` -> `[+]`
    *   `●` -> `*`
*   **Call Sites**:
    *   `packages/loopwork/src/commands/status.ts`: Used for task status icons.
*   `packages/loopwork/src/core/output.ts`: Used internally by `CompletionSummary`.
    *   `packages/loopwork/examples/output-demo.ts`.

---

## 4. Re-exports & Utilities Integration

### `packages/loopwork/src/core/utils.ts`
Most of these utilities are re-exported from `utils.ts` for easier access throughout the package.
```typescript
export { Table, Banner, ProgressBar, CompletionSummary, separator, supportsEmoji, getEmoji, BOX_CHARS } from './output'
```

### `logger.raw(msg: string)`
The `logger` utility in `utils.ts` provides a `raw()` method specifically designed to output the strings generated by these components without adding timestamps or prefixes.
*   **Usage Pattern**: `logger.raw(table.render())` or `logger.raw(banner.render())`.
*   **Implementation**: bypasses standard formatting and writes directly to `stdout`.

    *   `packages/loopwork/test/core/logger-raw.test.ts`.

### `createJsonOutput(command: string, data: Record<string, unknown>)`
*   **Contract**: `(command: string, data: Record<string, unknown>): string`
*   **Description**: Wraps data in a standard JSON output structure with a timestamp.
*   **Call Sites**:
    *   Exported but no direct usages found in the core commands (which often implement their own JSON logic or use `emitJsonEvent`).

### `emitJsonEvent(type, command, data)`
*   **Contract**: `(type: 'info' | 'success' | 'error' | 'warn' | 'progress' | 'result', command: string, data: Record<string, unknown>): void`
*   **Description**: Writes a newline-delimited JSON (NDJSON) event directly to `process.stdout`.
*   **Call Sites**:
    *   Exported. `packages/loopwork/src/commands/run.ts` implements a local version that uses the logger.

---

## 3. Classes

### `Table`
*   **Description**: A class for rendering Unicode box-drawing tables.
*   **Contract**:
    *   `constructor(headers: string[], columnConfigs?: ColumnConfig[])`
        *   `ColumnConfig`: `{ width?: number; align?: 'left' | 'right' | 'center' }`
    *   `addRow(cells: string[]): void`
    *   `render(): string`
*   **Call Sites**:
    *   `packages/loopwork/src/commands/monitor.ts`
    *   `packages/loopwork/src/commands/decompose.ts`
    *   `packages/loopwork/src/commands/processes.ts`
    *   `packages/loopwork/src/commands/status.ts`
    *   `packages/loopwork/src/commands/kill.ts`
*   **Edge Cases**:
    *   Strips ANSI codes for width calculation.
    *   Throws error if row length doesn't match header length.

### `Banner`
*   **Description**: A visually distinct box for announcements.
*   **Contract**:
    *   `constructor(title: string, style: 'light' | 'heavy' = 'heavy')`
    *   `addRow(key: string, value: string): void`
    *   `render(): string`
*   **Call Sites**:
    *   `packages/loopwork/src/commands/logs.ts`
    *   `packages/loopwork/src/commands/run.ts`
    *   `packages/loopwork/src/core/output.ts` (Internal usage in `CompletionSummary`).

### `ProgressBar`
*   **Description**: Progress tracking with TTY/Non-TTY awareness.
*   **Contract**:
    *   `constructor(total?: number)`
    *   `increment(): void`
    *   `tick(message?: string): void`
    *   `complete(message?: string): void`
*   **TTY Behavior**:
    *   **TTY**: Uses `\r\x1b[K` for in-place updates. Deterministic mode shows a bar and percentage. Indeterminate mode shows a spinner.
    *   **Non-TTY**: Logs discrete progress lines to `stdout`.
*   **Call Sites**:
    *   Mainly used in tests (`packages/loopwork/test/core/output.test.ts`).
    *   Note: `packages/loopwork/src/core/cli.ts` uses a manual progress implementation in `setInterval` instead of this class.

### `CompletionSummary`
*   **Description**: High-level summary of task execution.
*   **Contract**:
    *   `constructor(title: string)`
    *   `setStats(stats: { completed?: number; failed?: number; skipped?: number; isDegraded?: boolean; disabledPlugins?: string[]; })`
    *   `setDuration(ms: number)`
    *   `addNextStep(step: string)`
    *   `addNextSteps(steps: string[])`
    *   `render(): string`
*   **TTY Behavior**:
    *   **TTY**: Renders using the `Banner` class.
    *   **Non-TTY**: Renders as plain text with simple dividers.
*   **Call Sites**:
    *   `packages/loopwork/src/commands/run.ts`
    *   `packages/loopwork/src/commands/decompose.ts`
    *   `packages/loopwork/src/commands/init.ts`
    *   `packages/loopwork/src/commands/kill.ts`
